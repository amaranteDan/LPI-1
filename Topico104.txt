Tópico 104 - Dispositivos de Sistemas de arquivos Linux e padrão FHS

***104.1 Criar partiçoes e sistemas de Arquivos.

fdisk

ex fdisk -l /dev/sdb


Disk /dev/sda: 40 GiB, 42949672960 bytes, 83886080 sectors
Disk model: VMware Virtual S
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0xf789de7a

Device     Boot    Start      End  Sectors  Size Id Type
/dev/sda1  *        2048  1171455  1169408  571M 83 Linux
/dev/sda2        1173502 12890111 11716610  5.6G  5 Extended
/dev/sda3       12890112 83884031 70993920 33.9G 83 Linux
/dev/sda5        1173504  8984575  7811072  3.7G 83 Linux
/dev/sda6        8986624 12890111  3903488  1.9G 82 Linux swap / Solaris

Partition table entries are not in disk order.


Disk /dev/sdb: 7.47 GiB, 8022654976 bytes, 15669248 sectors
Disk model: USB Flash Disk  
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0xea8b1415

Device     Boot Start      End  Sectors  Size Id Type
/dev/sdb1  *       63 15667217 15667155  7.5G  7 HPFS/NTFS/exFAT


***Usando o gdisk

Ex: sudo gdisk /dev/sdb


GPT fdisk (gdisk) version 1.0.5

Partition table scan:
  MBR: MBR only
  BSD: not present
  APM: not present
  GPT: not present


***************************************************************
Found invalid GPT and valid MBR; converting MBR to GPT format
in memory. THIS OPERATION IS POTENTIALLY DESTRUCTIVE! Exit by
typing 'q' if you don't want to convert your MBR partitions
to GPT format!
***************************************************************


Command (? for help): Using 1
Partition GUID code: EBD0A0A2-B9E5-4433-87C0-68B6B72699C7 (Microsoft basic data)
Partition unique GUID: 46878199-FABF-4B1A-8568-71A73B3D2360
First sector: 63 (at 31.5 KiB)
Last sector: 15667217 (at 7.5 GiB)
Partition size: 15667155 sectors (7.5 GiB)
Attribute flags: 0000000000000000
Partition name: 'Microsoft basic data'

Command (? for help): 

? Para help
i Para mostrar detalhes da partição
l - Para listar as partiçoes
p - Imprimir tabela de partições
n - Adicionar nova partição
d - deletar partição
c - Mudar uma partição.
o - Criar nova partição GPT
w - Gravar partição

***No gdisk as partições conhecidas são:


Type search string, or <Enter> to show all codes: 
0700 Microsoft basic data                0c01 Microsoft reserved                
2700 Windows RE                          3000 ONIE boot                         
3001 ONIE config                         3900 Plan 9                            
4100 PowerPC PReP boot                   4200 Windows LDM data                  
4201 Windows LDM metadata                4202 Windows Storage Spaces            
7501 IBM GPFS                            7f00 ChromeOS kernel                   
7f01 ChromeOS root                       7f02 ChromeOS reserved                 
8200 Linux swap                          8300 Linux filesystem                  
8301 Linux reserved                      8302 Linux /home                       
8303 Linux x86 root (/)                  8304 Linux x86-64 root (/)             
8305 Linux ARM64 root (/)                8306 Linux /srv                        
8307 Linux ARM32 root (/)                8308 Linux dm-crypt                    
8309 Linux LUKS                          830a Linux IA-64 root (/)              
830b Linux x86 root verity               830c Linux x86-64 root verity          
830d Linux ARM32 root verity             830e Linux ARM64 root verity           
830f Linux IA-64 root verity             8310 Linux /var                        
8311 Linux /var/tmp                      8400 Intel Rapid Start                 
8500 Container Linux /usr                8501 Container Linux resizable rootfs  
8502 Container Linux /OEM customization  8503 Container Linux root on RAID      
8e00 Linux LVM                           a000 Android bootloader                
a001 Android bootloader 2                a002 Android boot 1     

#sudo gdisk -l /dev/sdb

Disk /dev/sdb: 15669248 sectors, 7.5 GiB
Model: USB Flash Disk  
Sector size (logical/physical): 512/512 bytes
Disk identifier (GUID): 4A45903D-AA0E-4BFA-8DF6-C4B2D7BA68DC
Partition table holds up to 128 entries
Main partition table begins at sector 2 and ends at sector 33
First usable sector is 34, last usable sector is 15669214
Partitions will be aligned on 1-sector boundaries
Total free space is 2026 sectors (1013.0 KiB)

Number  Start (sector)    End (sector)  Size       Code  Name
   1              63        15667217   7.5 GiB     0700  Microsoft basic data

***Pergunta de Prova?
Como é reconhecido (ou o codigo) uma partição efi no gdisk?
R: ef00 EFI SYSTEM

Qual o codigo de uma partição msdos no gdisk?
R: Bios boot partition


***Usando parted

#parted /dev/sdb

help - ajuda
GNU Parted 3.3
Using /dev/sdb
Welcome to GNU Parted! Type 'help' to view a list of commands.
(parted) help                                                             
  align-check TYPE N                       check partition N for TYPE(min|opt) alignment
  help [COMMAND]                           print general help, or help on COMMAND
  mklabel,mktable LABEL-TYPE               create a new disklabel (partition table)
  mkpart PART-TYPE [FS-TYPE] START END     make a partition
  name NUMBER NAME                         name partition NUMBER as NAME
  print [devices|free|list,all|NUMBER]     display the partition table, available devices, free
        space, all found partitions, or a particular partition
  quit                                     exit program
  rescue START END                         rescue a lost partition near START and END
  resizepart NUMBER END                    resize partition NUMBER
  rm NUMBER                                delete partition NUMBER
  select DEVICE                            choose the device to edit
  disk_set FLAG STATE                      change the FLAG on selected device
  disk_toggle [FLAG]                       toggle the state of FLAG on selected device
  set NUMBER FLAG STATE                    change the FLAG on partition NUMBER
  toggle [NUMBER [FLAG]]                   toggle the state of FLAG on partition NUMBER
  unit UNIT                                set the default unit to UNIT
  version                                  display the version number and copyright information
        of GNU Parted

print                                                            
Model: General USB Flash Disk (scsi)
Disk /dev/sdb: 8023MB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags: 

Number  Start   End     Size    Type     File system  Flags
 1      32.3kB  8022MB  8022MB  primary  ntfs         boot

version                                                          

GNU Parted 3.3

Copyright (C) 1998 - 2006 Free Software Foundation, Inc.
This program is free software, covered by the GNU General Public License.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

***Redimensionar partiçoes com /dev/sdb
#parted /dev/sdb

resizepart 1 500GB
Warning: Shring a partition can cause data los, are you sure you want to continue?

***Criando Novas partiçoes a partir do proprio parted

parted mkpart primary ext4 500GB 1100GB
	|	|	|	   |->Definen o começo e o final da partição	
	|	|	|->
	|	-> primaria
	|-> mkpart(mkpartfs	       

***Criação de Sistemas de arquivos


#mkfs.ext4 /dev/sdb1 - Formatando a partição para uso do ext4

***Excluindo a partição

parted select /dev/sdb

print

rm 1 - Remove a 1 partição

***Resgatar uma partição perdida

(parted) rescue
Start? 0MB
End? 1024MB


***Criando Sistemas de Arquivos

#ls /sbin/mkfs.*


/sbin/mkfs.bfs
/sbin/mkfs.cramfs
/sbin/mkfs.exfat
/sbin/mkfs.ext2
/sbin/mkfs.ext3
/sbin/mkfs.ext4
/sbin/mkfs.fat
/sbin/mkfs.jffs2
/sbin/mkfs.minix
/sbin/mkfs.msdos
/sbin/mkfs.ntfs
/sbin/mkfs.ubifs
/sbin/mkfs.vfat


#ls /sbin/mkfs* | egrep -o 'mkfs.[a-z0-9]+' | cut -d. -f2

bfs
cramfs
exfat
ext2
ext3
ext4
fat
jffs2
minix
msdos
ntfs
ubifs
vfat

EXT3  
#mkfs -t ext3 /dev/sda5
ou
#mkfs.ext3 /dev/sda5 mkfs.ext2

***Adicionando a label a partição criada

#e2label /dev/sda5 storage

***Formatando e definindo label

mke2fs -j -L storage /dev/sda5

Obs: a label não pode ultrapassar de 16 caracteres.

Ext3 - suporta journaling, o ext2 não

***Partição com reiserfs

mkfs.reiserfs /dev/sda5

reiserfstune -l storage /dev/sda5 - Criando uma label e ativando partição

Area de Swap

Tipo 82 swap

mkswap /dev/sda6

#cat /proc/swaps

***Ativando a swap

swapon /dev/sda6

#cat /proc/swaps

#free -mot

***Desativando a partição swap

#swapoff /dev/sda6

cat /proc/swaps

#free -mot

***Criando um arquivo como swap

# dd if=/dev/zero of=/swap bs=1M count=100

***Formatando como swap

mkswap /swap

***ativando a swap arquivo

swapon /swap


cat /proc/swaps

***Desativando

#swapoff /swap

***104.2 Integridade do sistema

***Verificando espaço livre
df -hT

df /
Filesystem     1K-blocks    Used Available Use% Mounted on
/dev/sda3       34677352 8930640  23955480  28% /

df -i - Informações de Uso de inodes


Filesystem      Inodes  IUsed   IFree IUse% Mounted on

udev            242685    411  242274    1% /dev
tmpfs           251093    680  250413    1% /run
/dev/sda3      2220032 298560 1921472   14% /
tmpfs           251093      1  251092    1% /dev/shm
tmpfs           251093      2  251091    1% /run/lock
tmpfs             1024     17    1007    2% /sys/fs/cgroup
/dev/sda1        36560    317   36243    1% /boot
/dev/sda5       244320  11894  232426    5% /var
tmpfs            50218     65   50153    1% /run/user/1000


#df -hT


Filesystem     Type      Size  Used Avail Use% Mounted on
udev           devtmpfs  948M     0  948M   0% /dev
tmpfs          tmpfs     197M  1.2M  196M   1% /run
/dev/sda3      ext4       34G  8.6G   23G  28% /
tmpfs          tmpfs     981M     0  981M   0% /dev/shm
tmpfs          tmpfs     5.0M     0  5.0M   0% /run/lock
tmpfs          tmpfs     4.0M     0  4.0M   0% /sys/fs/cgroup
/dev/sda1      ext4      547M   79M  428M  16% /boot
/dev/sda5      ext4      3.7G  2.3G  1.2G  68% /var
tmpfs          tmpfs     197M   56K  197M   1% /run/user/1000



***du - Disk Usage

-s Exibe sumariamente informações de tamanho
-c Exibe soma total
-h Formato humano

#du -hs *

|------------------------> tamanho dos arquivos
|
16K	comandos.txt
40K	dmesg.txt
12K	grubcfg.txt
4.0K	grub.txt
44K	journalctl.txt
4.0K	repo_debian
40K	Topico101.txt
24K	Topico102.txt
8.0K	Topico103-Comandos.txt
12K	Topico104.txt
8.0K	Topico110.txt

#du -hc *


16K	comandos.txt
40K	dmesg.txt
12K	grubcfg.txt
4.0K	grub.txt
44K	journalctl.txt
4.0K	repo_debian
40K	Topico101.txt
24K	Topico102.txt
8.0K	Topico103-Comandos.txt
12K	Topico104.txt
8.0K	Topico110.txt
212K	total

#sudo du -hc /var/log

***Verificando a integridade do Sistema

#ls /sbin/fsck.*

***Verificando a integridade do Sistema

#ls /sbin/fsck.*

***Verificando a integridade do Sistema

#ls /sbin/fsck.*

***Verificando a integridade do Sistema

#ls /sbin/fsck.*

***Verificando a integridade do Sistema

#ls /sbin/fsck.*

***Verificando a integridade do Sistema

#ls /sbin/fsck.*

***Verificando a integridade do Sistema

#ls /sbin/fsck.*

***Verificando a integridade do Sistema

fsck - verificar o arquivo /etc/fstab

#ls /sbin/fsck.*


/sbin/fsck.cramfs
/sbin/fsck.exfat
/sbin/fsck.ext2
/sbin/fsck.ext3
/sbin/fsck.ext4
/sbin/fsck.fat
/sbin/fsck.minix
/sbin/fsck.msdos
/sbin/fsck.vfat

#fsck /dev/sda5 - Verificando a partição

#fsck -f /dev/sda5


***Reparando o sistema

***Cada tipo de arquivo disponibiliza uma ferramenta de manutenção.


tune2fs - Para ext2/ext3/ext4. Pode ser usada para adicionar journaling na ext2 e tranformar loem ext3.

dumpe2fs - Exibe informação dos grupos de supreblocos do EXT2/3/4.

debugfs - Depurador do EXT2/3/4.

reiserfstune - Para sistemas reiserFs.

debugreiserfs - Depurador para reiserfs

xfs_info - Informações do xfs
xfs_growfs -Mesclar partiçoes XFS em unico sistema de arquivos

xfs_admin - Alterar parametros do xfs
xfs_repair - Modo de reparo do xfs

***mke2fs - Utilizado para criar arquivos, ext2, ext3 e ext4

mke2fs

Opçoes
-F   Força a execução
-j   Cria um sistema ext3
-c   Varredura do disco em busca de blocos ruins
-L   Atribui rotulo
-v   Exibe detalhes da execução
-V   Exibe a versão do comando

Ex
#mke2fs -j -v /dev/sdb1

***Comando tune2fs - POde configurar parametros para o sistema ext2,3,4.

tune2fs
-c *Configurar numero maximo de montagens
-g *Configura grupo de usuarios que podera utilizar blocos reservados
-j *Adiciona o journal ao sistema de arquivos
-l *Exibe conteudo
-m <numero_blocos> *Configura a porcentagem de blocos reservados
-u *Define usuario
-C *Esta oção mostra a quantidade de vezes que o sistema ja foi montado
-L *Informa a label

Ex:
tune2fs -c 15 /dev/sdb1

tune2fs -L Backup /dev/sdb1

tune2fs -m 10 /dev/sdb1

***Comandos com XFS

xfs_repair [opção] <dispositivo>

-n Apenas informar os erros
-v Exibe detalhes da saida do comando

# xfs_repair /dev/sdb1

xfs_fsr - Utilitario de desfragmentação
*Usado com o sistema montado e ativo

Ex:
# xfs_db -c frag -r /dev/sdb1

#xfs_fsr /dev/sdb1

***Visualizar numero de fragmentos existentes
xfs_bmap -v /dev/sdb1

Obs: xfs_db -r Podemos criar um arquivo contendo toda a fragmentação do disco

***103.4 Controla Montagens e desmontagens do sistema de arquivos


Ex
# mkdir /storage

# mount /dev/sda5 /storage

# df -hT

# cp -v /etc/hosts /storage

Obs: arquivo lost+found - Arquivo do sistema no ponto raiz que é gerado durante o processo do fsck e armazena fragmentos de arquivos recuperados

*Verificando os pontos de montagem
# mount

-t Especificar um ou mais pontos de montagem 

ex
# mount -t ext3,ext4,devpts

-o Permite definir opções de montagem

ro Somente leitura
rw leitura e escrita

Ex
# mount -o remount,ro /storage
# mount -t ext3

***Testando os dados

rm -f /storage/hosts

***Desmontando. Para manutençao, sempre desmontar
# umount /storage

Arquivo /etc/fstab



# <file system> <mount point>   <type>  <options>       <dump>  <pass>

# / was on /dev/sda3 during installation
UUID=923a359e-b4b1-4d62-bc54-194ef54faacc /               ext4    errors=remount-ro 0       1
# /boot was on /dev/sda1 during installation
UUID=ccbb56ac-0bc9-4432-97db-e7ef888cc9ec /boot           ext4    defaults        0       2
# /var was on /dev/sda5 during installation
UUID=7f74f184-23c0-4715-94b3-42310d9c8875 /var            ext4    defaults        0       2
# swap was on /dev/sda6 during installation
UUID=0a29a596-3668-415a-982a-b7df2ef40284 none            swap    sw              0       0
/dev/sr0        /media/cdrom0   udf,iso9660 user,noauto     0       0

***104.5 Gerenciamento de permissões

Usuarios e grupo

# whoami

***Grupos a que pertenço
# groups

dublin cdrom floppy sudo audio dip video plugdev netdev bluetooth scanner kaboxer

id -Verificando o id 

uid=1000(dublin) gid=1000(dublin) groups=1000(dublin),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),109(netdev),118(bluetooth),133(scanner),141(kaboxer)


***Alterar grupo dono

chgrp

Ex chgrp adm arq1
# chgrp cdrom arq2

#newgrp adm - Criando novo grupo

chown (Change owner) para alterar o usuario ou grupo dono
Ex: chown aluno arqu1

**Alterando o grupo dono
# chown adm: arqu1
# chown zeca:cdrom arq3

Encontrar links
# find . -samefile arquivo2

# find . -inum 8095




Donos de arquivos e permissões

# ls -l /bin/bash /home/dublin/ .basrc

***Realizando a leitura do arquivo

- Ausencia de permissão
r - leitura
w - escrita
x - execução

***Definição dos arquivos

- Arquivo comum
d - Diretorio
l - link simbolico
c - Dispositivo de caractere
b - Dispositivo de bloco
p - FIFO(pipe)
s - soquete

***Definindo permissão

#chmod
Ex # chmod +x olamundo.sh

ou chmod +rwx olamundo.sh

***Entendendo as permissões
u - usuario dono
g - grupo dono
o - outros usuarios
a - define permissões a todos os usuarios

Ex
#chmod ug+wx olamundo.sh - Definindo permissão para usuario dono/grupo dono escrita/execução

***Removendo as permissões

#chmod o-rwx olamundo.sh Removando todas as permissões para outros usuarios do script olamundo.sh

***Pode adiconar permissões paa mais de um arquivo com a opção -R ou --recursive

***Permissões especificas de um arquivo
Ex # chmod o= olamundo.sh
# chmod ug=rwx olamundo.sh Definindo ao usuario e grupo donos as permissões rwx para olamundo.sh
# chmod o=rw olamundo.sh Definindo a outros usuarios as permissões rw no arquivo olamundo.sh

***Entendendo as permissões octal

r = 4
w = 2
x = 1

umask de arquivos  666
umask de diretorio 777

Locais onde são definidos a umask
/etc/login.defs

Mascara padrão - 0002 Em sistemas onde os grupos iniciais são particulares
Mascara padrão - 0022 Em sistemas onde o grupo inicial pertencem a todos os usuarios
Ex 0777
-  0002
   0775 Permissão do diretorio - Siginifca que usuario dono permissão total/grupo, outros leitura e execução.

Ex 0666
-  0002
   0664 Permissão do arquivo - Significa que 

#umask - Comando que verifica valor padrão.
022

***Alterando a umask
#umask 0077

Permissões suid e guid

São permissões especiais herdadas do mesmo dono do comando

chmod u+s comando - Adiciono a permissão suid 

A letra s vai no lugar da x, indicando permissão suid

Sgid - atua nos grupos

chmod g+s comando

São as permissões forem adicionadas, aparecera a letra S
s aparecem nas permissões suid e sgid no dono do arquivo e grupo

Permissão sticky

Evitar que usuarios que não são donos do arquivos o apaguem.

ex
ls -l /tmp

drwxrwxrwt 16 root root 4096 Mar 10 09:09 /tmp

***Adicionando a permissão sticky

chmod o+t olamundo.sh

Permissões especiais em formato numerico

tabela

Digito	suid=4	sgid=2	sticky=1
o	-	-	-	
4	sim	-	-
6	sim	sim	-	
7	sim	sim	sim
chmod u=rwx,g=rwxs,o=rw olumundo.sh equivale a chmod 2775 olamundo.sh

chmod u=rwx,g=rwx,o=rwxt olamundo.sh equivale a chmod 1777 olamundo.sh 

Pode usar o 1 ou t para definir arquivos sticky.

***104.6 Criar e altera links simbolicos e hardlinks

Hardlink (Link Fisico)

Hardlinks são um ou mais nomes que um inode do sistema de arquivos pode ter.

***Criar hardlink

Ex:
# ln arquivos.tar.gz files.tar.gz

#ls -i mostra o numero de inodes que o arquivo tem.
           |-----> mostra o numero de hardlinks que o arquivo tem.
-rwxr-xr-x 1 dublin dublin 14262 Feb 25 16:05 comandos.txt
-rw-r--r-- 1 dublin dublin 37171 Feb 25 15:55 dmesg.txt
-rw-r--r-- 1 dublin dublin 10360 Feb 25 15:55 grubcfg.txt
-rw-r--r-- 1 dublin dublin  1176 Feb 25 15:55 grub.txt


Um arquivo so é excluido quando se apaga o hardlink.

Só é possivel criar hardlinks para arquivos.

***Links Simbolicos

Links simbolicos apontam para qualquer alvo.

*Criando sof link
ln -s aquivos.tar.gz backup.tar.gz
lrwxrwxrwx 1 root root         11 Jun 15  2020 update-grub2 -> update-grub
|-----> link simbolico.
-f recria o link simbolico

***104.7 Encontrar arquivos de sistemas e conhecer sua localização correta.

Diretórios que não podem ser montados em ontras partiçoes. Residem na raiz

/bin /sbin /etc /lib

/mnt /media Pontos de montagem para outras partições

/proc /sys
/dev

Diretorios que podem ser ponto de montagem

/boot
/home
/root
/tmp
/usr/local e /opt
/var


***Localizando arquivos

find and locate

which -usado para retornar o caminho completo e realizar busca apenas no diretorios definidos
pela variavel PATH.

#which systemctl
/usr/bin/systemctl

***Encontando links
# find . -samefile arq2

# find . - inum 8095

# find . -lname "*file3"

# find . -lname "*arquivo3"


# find . -lname "*arquivo5"


***Executar comando direto de seu diretorio

Ex # /sbin/fdisk /dev/sdb

Which para comandos embutidos no shell
type avalia como o shell vai localizar os comandos

Which - Retorna o caminho completo para o comando.



#which fdisk
/usr/sbin/fdisk


#which ls

/usr/bin/ls

#which fg

fg: shell built-in command

Whereis para obter mais informações sobre um comando

#whereis ls

ls: /usr/bin/ls /usr/share/man/man1/ls.1.gz

Find 

find /tmp -user aluno 2>/dev/null Fazendo busca por usuario

find /home -type d -groups alunos - Fazendo busca por tipo/grupo

locate - Pesquisar combinações de arquivos em um banco de dados.

local do diretorio /usr/bin/locate

#locate lspci

/boot/grub/i386-pc/lspci.mod
/usr/bin/lspci
/usr/lib/grub/i386-pc/lspci.mod
/usr/share/man/man8/lspci.8.gz


Usage: locate [OPTION]... [PATTERN]...
Search for entries in a mlocate database.

  -A, --all              only print entries that match all patterns
  -b, --basename         match only the base name of path names
  -c, --count            only print number of found entries
  -d, --database DBPATH  use DBPATH instead of default database (which is
                         /var/lib/mlocate/mlocate.db)
  -e, --existing         only print entries for currently existing files
  -L, --follow           follow trailing symbolic links when checking file
                         existence (default)
  -h, --help             print this help
  -i, --ignore-case      ignore case distinctions when matching patterns
  -l, --limit, -n LIMIT  limit output (or counting) to LIMIT entries
  -m, --mmap             ignored, for backward compatibility
  -P, --nofollow, -H     don't follow trailing symbolic links when checking file
                         existence
  -0, --null             separate entries with NUL on output
  -S, --statistics       don't search for entries, print statistics about each
                         used database
  -q, --quiet            report no error messages about reading databases
  -r, --regexp REGEXP    search for basic regexp REGEXP instead of patterns
      --regex            patterns are extended regexps
  -s, --stdio            ignored, for backward compatibility
  -V, --version          print version information
  -w, --wholename        match whole path name (default)

Report bugs to mitr@redhat.com.

Ex locate -c lspci - Faz apenas uma contagem de vezes que aparece

4



